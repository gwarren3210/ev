openapi: 3.0.3
info:
  title: Sports Betting EV Calculator API
  description: |
    A production-ready API for calculating Expected Value (EV) on sports betting markets
    using multiple devigging methods and sharp book aggregation.

    This service fetches live odds from the OddsShopper API, removes bookmaker vigorish
    using various devigging algorithms, and calculates the true expected value of a bet
    by comparing a target book's odds against aggregated sharp book probabilities.
  version: 1.0.1
  contact:
    name: API Support
servers:
  - url: https://stokastic.vercel.app


paths:
  /calculate-ev:
    post:
      summary: Calculate Expected Value
      description: |
        Calculates the Expected Value (EV) for a specific bet by comparing target book odds
        against aggregated sharp book probabilities.

        **Process:**
        1. Fetches live market data from OddsShopper API
        2. Identifies the targeted player offer
        3. Filters sharp books with complete two-sided markets
        4. Calculates true probability by aggregating devigged sharp book odds
        5. Calculates implied probability from target book odds
        6. Computes final EV percentage
      operationId: calculateEV
      tags:
        - EV Calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateEVRequest'
            examples:
              basic:
                summary: Basic EV calculation
                value:
                  offerId: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
                  playerId: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
                  sharps: ["Kalshi", "NoVig", "BetMGM"]
                  targetBook: "BetRivers"
                  line: 18.5
                  side: "Over"
                  devigMethod: "multiplicative"

      responses:
        '200':
          description: EV calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculateEVResponse'
              example:
                player: "Player A"
                market: "Points"
                line: 18.5
                side: "Over"
                targetBook: "BetRivers"
                targetOdds: -110
                trueProbability: 0.52
                impliedProbability: 0.48
                expectedValue: 5.8
                sharpsUsed: ["Kalshi", "NoVig"]
                bestAvailableOdds:
                  sportsbookCode: "Kalshi"
                  americanOdds: -105
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                error: "Invalid request body"
                details: "side must be either 'Over' or 'Under'"
        '404':
          description: Offer or outcome not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              example:
                error: "Offer not found for ID: 00000000-0000-0000-0000-000000000000"
                code: "OFFER_NOT_FOUND"
        '409':
          description: One-sided market error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              example:
                error: "Target outcome not complete for book: DraftKings"
                code: "ONE_SIDED_MARKET"
        '422':
          description: Calculation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              example:
                error: "No sharp outcomes found for sharps: Pinnacle, BookMaker"
                code: "NO_SHARP_OUTCOMES"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
              example:
                error: "Internal server error"
        '502':
          description: Upstream API error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
              example:
                error: "Upstream error: Service Unavailable"
                code: "API_ERROR"

  /calculate-ev/sample:
    get:
      summary: Get Sample EV Request
      description: |
        Returns a sample request body for the /calculate-ev endpoint using live market data.

        This is useful for testing the API or understanding the request format.
        The sample is generated from current live odds data.
      operationId: getSampleEVRequest
      tags:
        - EV Calculation
      responses:
        '200':
          description: Sample request generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SampleResponse'
              example:
                description: "Sample request for player"
                request:
                  offerId: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
                  playerId: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
                  line: 18.5
                  side: "Over"
                  targetBook: "BetRivers"
                  sharps: ["Kalshi", "NoVig", "BetMGM"]
                  devigMethod: "multiplicative"
                curl: "curl -X POST 'https://stokastic.vercel.app/calculate-ev' -H 'Content-Type: application/json' -d '{\"offerId\":\"aa4dd9a9-6aec-44f9-8ae0-3599520b9351\",\"playerId\":\"1a1f9906-2493-4446-a4bd-c013bc30e7e2\",\"line\":18.5,\"side\":\"Over\",\"targetBook\":\"BetRivers\",\"sharps\":[\"Kalshi\",\"NoVig\",\"BetMGM\"],\"devigMethod\":\"multiplicative\"}'"
        '503':
          description: No live sample data available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
              example:
                error: "No live sample data available"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
              example:
                error: "Internal server error"

  /calculate-ev/batch:
    post:
      summary: Batch Calculate Expected Value
      description: |
        Calculates Expected Value (EV) for multiple bets in a single request.
        All items must share the same offerId, which allows for a single API call
        to fetch market data, improving efficiency.

        **Benefits:**
        - Single API call for market data (offerId is shared)
        - Individual item caching
        - Partial success handling (some items can fail while others succeed)

        **Limits:**
        - Maximum 10 items per batch request
      operationId: calculateEVBatch
      tags:
        - EV Calculation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchCalculateEVRequest'
            examples:
              basic:
                summary: Batch of 2 player bets
                value:
                  offerId: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
                  items:
                    - playerId: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
                      line: 18.5
                      side: "Over"
                      targetBook: "BetRivers"
                      sharps: ["Kalshi", "NoVig"]
                      devigMethod: "multiplicative"
                    - playerId: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
                      line: 18.5
                      side: "Under"
                      targetBook: "BetRivers"
                      sharps: ["Kalshi", "NoVig"]
                      devigMethod: "multiplicative"
                      bankroll: 1000
      responses:
        '200':
          description: Batch processed (may contain partial failures)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchCalculateEVResponse'
              example:
                offerId: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
                totalItems: 2
                successCount: 2
                errorCount: 0
                results:
                  - index: 0
                    success: true
                    result:
                      player: "Player A"
                      market: "Points"
                      line: 18.5
                      side: "Over"
                      targetBook: "BetRivers"
                      targetOdds: -110
                      trueProbability: 0.52
                      impliedProbability: 0.48
                      expectedValue: 5.8
                      sharpsUsed: ["Kalshi", "NoVig"]
                      bestAvailableOdds:
                        sportsbookCode: "Kalshi"
                        americanOdds: -105
                  - index: 1
                    success: true
                    result:
                      player: "Player A"
                      market: "Points"
                      line: 18.5
                      side: "Under"
                      targetBook: "BetRivers"
                      targetOdds: 100
                      trueProbability: 0.48
                      impliedProbability: 0.50
                      expectedValue: -4.0
                      sharpsUsed: ["Kalshi", "NoVig"]
                      bestAvailableOdds:
                        sportsbookCode: "BetRivers"
                        americanOdds: 100
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                error: "Invalid request body"
                details: "items must contain at least 1 item"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
              example:
                error: "Internal server error"

  /calculate-ev/batch/sample:
    get:
      summary: Get Sample Batch EV Request
      description: |
        Returns a sample request body for the /calculate-ev/batch endpoint using live market data.

        This is useful for testing the batch API or understanding the request format.
        The sample includes multiple players from the same offer.
      operationId: getSampleBatchEVRequest
      tags:
        - EV Calculation
      responses:
        '200':
          description: Sample batch request generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchSampleResponse'
              example:
                description: "Batch sample with Over and Under for same player"
                playerNames: ["Player A"]
                request:
                  offerId: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
                  items:
                    - playerId: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
                      line: 18.5
                      side: "Over"
                      targetBook: "BetRivers"
                      sharps: ["Kalshi", "NoVig"]
                      devigMethod: "multiplicative"
                    - playerId: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
                      line: 18.5
                      side: "Under"
                      targetBook: "BetRivers"
                      sharps: ["Kalshi", "NoVig"]
                      devigMethod: "multiplicative"
                curl: "curl -X POST 'https://stokastic.vercel.app/calculate-ev/batch' -H 'Content-Type: application/json' -d '{\"offerId\":\"aa4dd9a9-6aec-44f9-8ae0-3599520b9351\",\"items\":[{\"playerId\":\"1a1f9906-2493-4446-a4bd-c013bc30e7e2\",\"line\":18.5,\"side\":\"Over\",\"targetBook\":\"BetRivers\",\"sharps\":[\"Kalshi\",\"NoVig\"],\"devigMethod\":\"multiplicative\"},{\"playerId\":\"1a1f9906-2493-4446-a4bd-c013bc30e7e2\",\"line\":18.5,\"side\":\"Under\",\"targetBook\":\"BetRivers\",\"sharps\":[\"Kalshi\",\"NoVig\"],\"devigMethod\":\"multiplicative\"}]}'"
        '503':
          description: No live sample data available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
              example:
                error: "No live sample data available"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericError'
              example:
                error: "Internal server error"

  /test:
    get:
      summary: Health check
      description: Simple health check endpoint to verify the service is running
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            text/plain:
              schema:
                type: string
                example: "test"

components:
  schemas:
    CalculateEVRequest:
      type: object
      required:
        - offerId
        - playerId
        - sharps
        - targetBook
        - line
        - side
        - devigMethod
      properties:
        offerId:
          type: string
          description: The unique offer identifier from OddsShopper API (UUID format)
          example: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
        playerId:
          type: string
          description: The unique player identifier (UUID format)
          example: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
        sharps:
          type: array
          description: Array of sharp sportsbook codes to aggregate for true probability
          items:
            type: string
          minItems: 1
          example: ["Kalshi", "NoVig", "BetMGM"]
        targetBook:
          type: string
          description: The target sportsbook code to evaluate for EV
          example: "BetRivers"
        line:
          type: number
          description: The betting line (e.g., 18.5 points, 1.5 hits)
          example: 18.5
        side:
          type: string
          enum: [Over, Under]
          description: The side of the bet
          example: "Over"
        devigMethod:
          type: string
          enum: [multiplicative, additive, power, shin, osskewed]
          description: |
            The devigging method to use:
            - **multiplicative**: Margin proportional to odds (most common)
            - **additive**: Equal vig distribution across outcomes
            - **power**: Logarithmic distribution via binary search
            - **shin**: Assumes insider trading (equivalent to additive for n=2)
            - **osskewed**: Over/Under specific (65% vig on Over, 35% on Under)
          example: "multiplicative"
        bankroll:
          type: number
          description: Optional bankroll amount for Kelly Criterion bet sizing
          minimum: 0
          exclusiveMinimum: true
          example: 1000

    CalculateEVResponse:
      type: object
      required:
        - player
        - market
        - line
        - side
        - targetBook
        - targetOdds
        - trueProbability
        - impliedProbability
        - expectedValue
        - sharpsUsed
        - bestAvailableOdds
      properties:
        player:
          type: string
          description: Player name
          example: "Player A"
        market:
          type: string
          description: Market type
          example: "Points"
        line:
          type: number
          description: The betting line
          example: 18.5
        side:
          type: string
          enum: [Over, Under]
          description: The side of the bet
          example: "Over"
        targetBook:
          type: string
          description: Target sportsbook that was evaluated
          example: "BetRivers"
        targetOdds:
          type: number
          description: American odds from the target book (e.g., -110, +150)
          example: -110
        trueProbability:
          type: number
          description: Estimated true probability of the outcome (0 to 1)
          minimum: 0
          maximum: 1
          example: 0.52
        impliedProbability:
          type: number
          description: Target book's devigged implied probability (0 to 1)
          minimum: 0
          maximum: 1
          example: 0.48
        expectedValue:
          type: number
          description: Expected Value as a percentage (e.g., 5.2 means 5.2% EV)
          example: 5.8
        sharpsUsed:
          type: array
          description: Sharp books that were successfully used in the calculation
          items:
            type: string
          example: ["Kalshi", "NoVig"]
        bestAvailableOdds:
          type: object
          description: Best odds available across all sportsbooks for this side
          required:
            - sportsbookCode
            - americanOdds
          properties:
            sportsbookCode:
              type: string
              description: The sportsbook offering the best odds
              example: "Kalshi"
            americanOdds:
              type: number
              description: The best American odds available
              example: -105
        kelly:
          $ref: '#/components/schemas/KellyBetSizing'

    ApiError:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
          example: "Offer not found for ID: abc123"
        code:
          type: string
          description: Machine-readable error code
          enum:
            - OFFER_NOT_FOUND
            - OFFER_NOT_FOUND_FOR_PLAYER
            - TARGET_OUTCOME_NOT_FOUND
            - TARGET_BOOK_SIDE_MISSING
            - ONE_SIDED_MARKET
            - NO_SHARP_OUTCOMES
            - DEVIG_ERROR
            - API_ERROR
            - INVALID_ODDS
          example: "OFFER_NOT_FOUND"

    ValidationError:
      type: object
      required:
        - error
        - details
      properties:
        error:
          type: string
          description: High-level error description
          example: "Invalid request body"
        details:
          type: string
          description: Detailed validation error message
          example: "side must be either 'Over' or 'Under'"

    GenericError:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Internal server error"

    SampleResponse:
      type: object
      description: Sample request response for single EV calculation
      required:
        - description
        - request
        - curl
      properties:
        description:
          type: string
          description: Human-readable description of the sample
          example: "Sample request for player"
        request:
          $ref: '#/components/schemas/CalculateEVRequest'
        curl:
          type: string
          description: Ready-to-use curl command
          example: "curl -X POST 'https://stokastic.vercel.app/calculate-ev' ..."

    BatchSampleResponse:
      type: object
      description: Sample request response for batch EV calculation
      required:
        - description
        - playerNames
        - request
        - curl
      properties:
        description:
          type: string
          description: Human-readable description of the sample
          example: "Batch sample with 3 players"
        playerNames:
          type: array
          description: Names of players included in the sample
          items:
            type: string
          example: ["Player A", "Player B", "Player C"]
        request:
          $ref: '#/components/schemas/BatchCalculateEVRequest'
        curl:
          type: string
          description: Ready-to-use curl command
          example: "curl -X POST 'https://stokastic.vercel.app/calculate-ev/batch' ..."

    KellyBetSizing:
      type: object
      description: Kelly Criterion bet sizing output (only included when bankroll is provided)
      required:
        - full
        - quarter
        - recommendedBet
        - expectedProfit
        - bankroll
      properties:
        full:
          type: number
          description: Full Kelly fraction (what percentage of bankroll to bet)
          example: 0.052
        quarter:
          type: number
          description: Quarter Kelly fraction (conservative 0.25x Kelly)
          example: 0.013
        recommendedBet:
          type: number
          description: Recommended bet amount in the same units as bankroll
          example: 13
        expectedProfit:
          type: number
          description: Expected profit based on EV and recommended bet
          example: 2.02
        bankroll:
          type: number
          description: The bankroll value used for calculation
          example: 1000

    BatchEVItem:
      type: object
      description: A single item in a batch EV calculation request
      required:
        - playerId
        - line
        - side
        - targetBook
        - sharps
        - devigMethod
      properties:
        playerId:
          type: string
          description: The unique player identifier (UUID format)
          example: "1a1f9906-2493-4446-a4bd-c013bc30e7e2"
        line:
          type: number
          description: The betting line
          example: 18.5
        side:
          type: string
          enum: [Over, Under]
          description: The side of the bet
          example: "Over"
        targetBook:
          type: string
          description: The target sportsbook code to evaluate for EV
          example: "BetRivers"
        sharps:
          type: array
          description: Array of sharp sportsbook codes
          items:
            type: string
          minItems: 1
          example: ["Kalshi", "NoVig"]
        devigMethod:
          type: string
          enum: [multiplicative, additive, power, shin, osskewed]
          description: The devigging method to use
          example: "multiplicative"
        bankroll:
          type: number
          description: Optional bankroll amount for Kelly Criterion bet sizing
          minimum: 0
          exclusiveMinimum: true
          example: 1000

    BatchCalculateEVRequest:
      type: object
      description: Request body for batch EV calculation. All items share the same offerId.
      required:
        - offerId
        - items
      properties:
        offerId:
          type: string
          description: The unique offer identifier from OddsShopper API (shared by all items, UUID format)
          example: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
        items:
          type: array
          description: Array of items to calculate EV for (max 10)
          items:
            $ref: '#/components/schemas/BatchEVItem'
          minItems: 1
          maxItems: 10

    BatchItemResultSuccess:
      type: object
      required:
        - index
        - success
        - result
      properties:
        index:
          type: integer
          description: Index of this item in the original request
          example: 0
        success:
          type: boolean
          enum: [true]
        result:
          $ref: '#/components/schemas/CalculateEVResponse'

    BatchItemResultError:
      type: object
      required:
        - index
        - success
        - error
      properties:
        index:
          type: integer
          description: Index of this item in the original request
          example: 1
        success:
          type: boolean
          enum: [false]
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: "OFFER_NOT_FOUND_FOR_PLAYER"
            message:
              type: string
              description: Human-readable error message
              example: "Offer not found for player ID: 00000000-0000-0000-0000-000000000000"

    BatchCalculateEVResponse:
      type: object
      description: Response body for batch EV calculation
      required:
        - offerId
        - totalItems
        - successCount
        - errorCount
        - results
      properties:
        offerId:
          type: string
          description: The offer ID that was processed (UUID format)
          example: "aa4dd9a9-6aec-44f9-8ae0-3599520b9351"
        totalItems:
          type: integer
          description: Total number of items in the request
          example: 3
        successCount:
          type: integer
          description: Number of successfully calculated items
          example: 2
        errorCount:
          type: integer
          description: Number of failed items
          example: 1
        results:
          type: array
          description: Results for each item (in request order)
          items:
            oneOf:
              - $ref: '#/components/schemas/BatchItemResultSuccess'
              - $ref: '#/components/schemas/BatchItemResultError'

tags:
  - name: EV Calculation
    description: Calculate expected value for sports bets
  - name: Health
    description: Health check endpoints
